<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Limbo Chat</title>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: Arial, sans-serif;
      background: #f1f1f1;
      overflow: hidden;
    }

    body {
      height: calc(var(--vh, 1vh) * 100);
      display: flex;
      flex-direction: column;
    }

    #messages {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
      padding-bottom: 80px; /* space for input bar */
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
    }

    .message {
      max-width: 70%;
      padding: 10px;
      margin: 5px;
      border-radius: 15px;
      word-wrap: break-word;
    }

    .sent-me {
      background: #dcf8c6;
      align-self: flex-end;
    }

    .sent-other {
      background: #e0e0ff;
      align-self: flex-start;
    }

    #inputArea {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      display: flex;
      padding: 10px;
      background: #fff;
      box-shadow: 0 -1px 4px rgba(0,0,0,0.15);
      z-index: 100;
    }

    #messageInput {
      flex: 1;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 20px;
      margin-right: 10px;
      font-size: 16px; /* prevents iOS zoom */
    }

    button {
      padding: 10px 16px;
      border: none;
      background: #4caf50;
      color: white;
      border-radius: 20px;
      font-size: 16px;
      cursor: pointer;
    }
  </style>
</head>

<body>

  <div id="messages"></div>

  <div id="inputArea">
    <input id="messageInput" placeholder="Type a messageâ€¦" />
    <button onclick="sendMessage()">Send</button>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <script>
    // âœ… Fix mobile viewport resizing
    function setVH() {
      document.documentElement.style.setProperty(
        "--vh",
        `${window.innerHeight * 0.01}px`
      );
    }
    window.addEventListener("resize", setVH);
    setVH();

    // ðŸ”Š Notification sound
    const notificationSound = new Audio(
      "https://actions.google.com/sounds/v1/cartoon/pop.ogg"
    );
    let audioUnlocked = false;

    document.body.addEventListener("click", () => {
      if (!audioUnlocked) {
        notificationSound.play().then(() => {
          notificationSound.pause();
          notificationSound.currentTime = 0;
          audioUnlocked = true;
        }).catch(() => {});
      }
    }, { once: true });

    // ðŸ”¥ Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyC_sFl5IAEVgCh1HATSgGigFhWwdfsWU5s",
      authDomain: "limbo-61aa1.firebaseapp.com",
      databaseURL: "https://limbo-61aa1-default-rtdb.asia-southeast1.firebasedatabase.app/",
      projectId: "limbo-61aa1",
      storageBucket: "limbo-61aa1.appspot.com",
      messagingSenderId: "336340515566",
      appId: "1:336340515566:web:ce1d1c0b910a758b3311ff"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Room ID
    const params = new URLSearchParams(window.location.search);
    const roomId = params.get("room");
    if (!roomId) {
      alert("No chat room specified.");
      throw new Error("Missing room ID");
    }

    const chatRef = db.ref(`chats/${roomId}`);

    // Device identity
    if (!localStorage.getItem("limboDeviceId")) {
      localStorage.setItem("limboDeviceId", crypto.randomUUID());
    }
    const deviceId = localStorage.getItem("limboDeviceId");

    const messagesDiv = document.getElementById("messages");
    const input = document.getElementById("messageInput");

    function scrollToBottom() {
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    input.addEventListener("focus", () => {
      setTimeout(scrollToBottom, 300);
    });

    function sendMessage() {
      const text = input.value.trim();
      if (!text) return;

      chatRef.push({
        text,
        sender: deviceId,
        timestamp: Date.now()
      });

      input.value = "";
      scrollToBottom();
    }

    chatRef.on("child_added", snapshot => {
      const msg = snapshot.val();
      const div = document.createElement("div");
      div.classList.add("message");
      div.classList.add(msg.sender === deviceId ? "sent-me" : "sent-other");
      div.textContent = msg.text;
      messagesDiv.appendChild(div);

      if (msg.sender !== deviceId && audioUnlocked) {
        notificationSound.currentTime = 0;
        notificationSound.play().catch(() => {});
      }

      scrollToBottom();
    });
  </script>

</body>
</html>
